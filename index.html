<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js" integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8shuf57BaghqFfPlYxofvL8/KUEfYiJOMMV+rV" crossorigin="anonymous"></script>
    <!-- <link href="/open-iconic/font/css/open-iconic.css" rel="stylesheet"> -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/open-iconic/1.1.1/font/css/open-iconic-bootstrap.min.css" integrity="sha256-BJ/G+e+y7bQdrYkS2RBTyNfBHpA9IuGaPmf9htub5MQ=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">

    <link rel="stylesheet" href="style.css">
    <script src="audio.js"></script>
    <script src="quizes.js"></script>

    <link rel="stylesheet" href="chatbot/style.css">
    <script src="chatbot/content/conversations_basic.js"></script>
    <script src="chatbot/src/diff_match_patch.js"></script>
    <script src="chatbot/script.js"></script>

    <title>Welcome</title>
    <style>
      .btn-light, .btn-light:hover, .btn-light:active, .btn-light:visited {
          background-color: #darkgray !important;
          border-color: white !important;
      }
      /*.grid:not(img) {
        transform: rotateX(50deg) rotateZ(55deg);
      }*/
    </style>
  </head>
  <body>
    <div class="d-flex flex-column flex-md-row align-items-center p-3 px-md-4 mb-3 bg-white border-bottom shadow-sm">
      <h5 class="my-0 mr-md-auto font-weight-normal">Punjabi</h5>
      <div class="demo col-4 text-center"><em class="demo4 text-muted">Credits <span id="credits"></span></em></div>
      <nav class="my-2 my-md-0 mr-md-3">
        <div class="dropdown">
          <button class="btn btn-light text-primary dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            Voice
          </button>
          <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
            <a class="dropdown-item" href="#" onclick="change_voice(0)">Child</a>
            <a class="dropdown-item" href="#" onclick="change_voice(1)">Female</a>
            <a class="dropdown-item" href="#" onclick="change_voice(2)">Male</a>
          </div>
        </div>
      </nav>
      <nav class="my-2 my-md-0 mr-md-3">
        <!-- <a class="p-2 text-dark" href="#">Features</a> -->
        <!-- <a class="p-2 text-dark" href="#">Enterprise</a> -->
        <!-- <a class="p-2 text-dark" href="#">Help</a> -->
        <!-- <a class="p-2 text-dark" href="#">Squares</a> -->
        <div class="dropdown">
          <button class="btn btn-light text-primary dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            Theme
          </button>
          <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
            <a class="dropdown-item" href="#" onclick="change_theme('primary')">Blue</a>
            <a class="dropdown-item" href="#" onclick="change_theme('secondary')">Gray</a>
            <a class="dropdown-item" href="#" onclick="change_theme('success')">Green</a>
            <a class="dropdown-item" href="#" onclick="change_theme('info')">Turquiose</a>
            <a class="dropdown-item" href="#" onclick="change_theme('warning')">Orange</a>
            <a class="dropdown-item" href="#" onclick="change_theme('danger')">Red</a>
            <a class="dropdown-item" href="#" onclick="change_theme('light')">Light</a>
            <a class="dropdown-item" href="#" onclick="change_theme('dark')">Dark</a>
            <a class="dropdown-item" href="#" onclick="clear_theme()">Original</a>
          </div>
        </div>
      </nav>
      <a class="btn btn-outline-primary text-primary" href="#" id="user" onclick="signin_user()">User</a>
    </div>

    <script type="text/javascript">
      function sigup_modal() {
        $("#exampleModal").modal('show');
      }
      function signup_submit() {
        user.name = $("#userInputName").val();
        user.email = $("#userInputEmail").val();
        user.id = $("#userInputEmail").val();
        user.id = user.id.replace(/\@.*/, ''); // first part of email
        set_user(user);
        $("#exampleModal").modal('hide');
      }
    </script>

    <!-- Modal -->
    <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-xl">
        <div class="modal-content">
          <div class="modal-body">
            <div class="col-sm-9 col-md-7 col-lg-5 mx-auto">
              <div class="card card-signin my-5">
                <div class="card-body">
                  <h5 class="card-title text-center">Create User</h5>
                  <form>
                    <div class="form-group">
                      <label for="userInputName">Name</label>
                      <input type="text" class="form-control" id="userInputName" aria-describedby="nameHelp" placeholder="Enter Name">
                      <small id="emailHelp" class="form-text text-muted">First name will do.</small>
                    </div>
                    <div class="form-group">
                      <label for="userInputEmail">Email address</label>
                      <input type="email" class="form-control" id="userInputEmail" aria-describedby="emailHelp" placeholder="Enter email">
                      <small id="emailHelp" class="form-text text-muted">Will be your primary user-id.</small>
                    </div>
                    <!-- <div class="form-group">
                      <label for="userInputPassword1">Password</label>
                      <input type="password" class="form-control" id="userInputPassword1" placeholder="Password">
                    </div> -->
                    <button type="submit" class="btn btn-primary" onclick="signup_submit()">Submit</button>
                  </form>
                </div>
              </div>
            </div>
          </div>
          <!-- <div class="modal-footer"> -->
            <!-- <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button> -->
            <!-- <button type="button" class="btn btn-primary">Save changes</button> -->
          <!-- </div> -->
        </div>
      </div>
    </div>

    <script>
      let voiceOver = new VoiceOver();
      let theme = get_theme() || 'primary';
      let classnames = ['btn-primary', 'btn-outline-primary', 'bg-primary', 'border-primary', 'text-primary'];
      // let lookup = {blue: primary, gray: secondary, green: }
      function change_theme(theme_new, theme_old=theme) {
        console.log(`........... changing theme ................`);
        console.log(`old-theme = ${theme_old}`)
        console.log(`new-theme = ${theme_new}`)
        // let elements = document.querySelectorAll(["class$="+theme_old]);
        let elements = document.querySelectorAll("*");
        for(let element of elements) {
          for(let classname of classnames) {
            let classname_old = classname.replace('primary', theme_old);
            let classname_new = classname.replace('primary', theme_new);
            // if(classname_new.match(/text/)) {
            //   console.log(`==================== ${classname_old} -> ${classname_new} ================`)
            //   classname_old = (theme_new==='light') ? 'text-white' : 'text-muted';
            //   classname_new = (theme_new==='light') ? 'text-muted' : 'text-white';
            //   console.log(`==================== ${classname_old} -> ${classname_new} ================`)
            // }
            if(is_exempt(element)) continue;

            if($(element).hasClass('text-muted') && theme_new!=='light') {
              $(element).removeClass('text-muted');
              $(element).addClass('text-white');
            }
            if($(element).hasClass('text-white') && theme_new==='light') {
              $(element).removeClass('text-white');
              $(element).addClass('text-muted');
            }
            if($(element).hasClass(classname_old) && theme_new==='light') {
              $(element).removeClass('text-light');
              $(element).addClass('text-muted');
            }
            if($(element).hasClass('bg-light') && theme_new!=='light') {
              $(element).removeClass('bg-light');
              $(element).addClass('bg-'+theme_new);
            }
            // if(!has_class(element, classname_old)) continue;
            // remove_class(element, classname_old);
            // add_class(element, classname_new);
            if(!$(element).hasClass(classname_old)) continue;
            console.log(`........... changing class ................`);
            console.log(`old-class = ${classname_old}`)
            console.log(`new-class = ${classname_new}`)
            $(element).removeClass(classname_old);
            $(element).addClass(classname_new);
            // $(element).addClass('border-primary');
          }
        }
        theme = theme_new;
        save_theme(theme);
      }
      function is_exempt(element) {
        let list = ['btn0', 'btn1', 'btn2', 'btn3', 'check-progress', 'send-progress', 'clear_storage'];
        for(let id of list) { if(element.id===id) return true }
        if($(element).hasClass("text-exempt")) return true;
        return false;
      }
      function set_theme(theme) {
        if(!theme) theme = get_theme();
        // if(!theme) theme = 'primary';
        if(!theme) return;
        change_theme(theme);
      }
     function get_theme() {
        return window.localStorage.getItem(user.id+'/theme');
      }
     function save_theme(_theme) {
        _theme = _theme || theme;
        return window.localStorage.setItem(user.id+'/theme', theme);
      }
     function clear_theme() {
        window.localStorage.removeItem(user.id+'/theme');
        if(confirm("Original theme setting needs to reload this page.\nPress 'OK' to reload now.\nPress 'Cancel' to reload later.")) location.reload();
      }
      function init_voice() {
        let voice = window.localStorage.getItem(user.id+'/voice');
        console.log(`init_voice() : ${voice}, ${user.id}`)
        voice = voice ? parseInt(voice) : 0;
        voiceOver.change_voice(voice);
      }
      function change_voice(voice) {
        console.log(`change_voice() : ${voice}, ${user.id}`)
        voiceOver.change_voice(voice);
        window.localStorage.setItem(user.id+'/voice', voice);
      }
     </script>

    <div class="squares-header px-3 py-3 pt-md-3 pb-md-3 mx-auto text-center">
      <!-- <h3 class="display-5">Colors</h3> -->
      <p class="lead" id="quiz-card-topic-text">Primary colors</p>
    </div>

    <script>
      const VERSION = 0.7;
      const DEBUG_MODE = 0;
      let nopopup = 0;
      let automagic = 0;
      let accelerate = 1; // set to 1x
      let speedup = 1; // set to 1x
      let voice_on = 1;
      let oncredit = 0;
      let credits = 0;
      let results = [];
      let index = 0;
      let user = {}; //name, email, id
      let info = {}; //project-name, current-quiz-topic
      let quiz;
      let states = [];
      let oneoff = false;
      let building_num = 0;
      let loop_data = { day: 1, hour: 0, minute: 0, stamp: 0 };
      let mapdata = { population: 0, enrolled: 0, tickets: 0 };
      let max_level2_plus_reached = 0;
      let max_level3_plus_reached = 0;
      // user = { name: 'Parminder', email: 'pgill18.dev@gmail.com', id: 'pgill18.dev' };
      let fileName = 'myData.json'; // for save-as
      $( document ).ready(function(){
        signin_user(user);
        init_voice();
        // set_user(user);
        load_page();
        load_quiz();
        set_theme();
        // quiz = load_quiz();
        // load_question(index);
        // let data = window.localStorage.getItem(user.id);
        // loop();
        run_loop();
      });
      async function run_loop() {
        while(1) {
          // let loopwait = 10*1000; // loops every 10 seconds
          // if(speedup>1) loopwait = 1000; // fastest can go 1 sec maybe?
          let loopwait = 10; // loops every 10 seconds
          if(speedup>1) loopwait = 1; // fastest can go 1 sec maybe?
          await delay(loopwait); // runsloop every 30 seconds
          console.log(`loop time...`)
          await loop();
          console.log(`loopend time...`)
        }
      }
      function load_page() {
        console.log(`a----------------`)
        console.log(JSON.parse(window.localStorage.getItem(user.id)));
        console.log(`b----------------`)
        for(let i=0; i<quizes.length; i++) {
          if(i>MAX_QUIZES-1) continue;
          // let {info, quiz} = quizes[i];
          quiz = quizes[i].quiz;
          info = quizes[i].info;
          index = i; building_num = i;
          state = i<3 ? 1 : i<4 ? 0.5 : 0;
          if(max_level2_plus_reached > 0) {
            // every level 2 or higher level adds an additional quiz to the maximum of 3
            if(i===3 && max_level2_plus_reached>=1) state = 1;
            if(i===4 && max_level2_plus_reached>=2) state = 1;
            if(i===5 && max_level2_plus_reached>=3) state = 1;
            // every level 3 or higher level adds an additional quiz to the maximum of 3
            if(i===6 && max_level3_plus_reached>=1 && max_level2_plus_reached>=4) state = 1;
            if(i===7 && max_level3_plus_reached>=2 && max_level2_plus_reached>=5) state = 1;
            if(i===8 && max_level3_plus_reached>=3 && max_level2_plus_reached>=6) state = 1;
          }
          states[i] = state;
          console.log(`i = ${i}, state = ${state}, max_level2_plus_reached = ${max_level2_plus_reached}, max_level3_plus_reached = ${max_level3_plus_reached}`)
          load_building(i, quiz, info, {state});
          // $(`#building-${i}-header`).text(info.header);
          // $(`#building-${i}-count`).text(quiz.length);
        }
        quiz = quizes[0].quiz;
        info = quizes[0].info;
        index = 0; building_num = 0;
        load_scorecard();
        load_mapdata();
        // load credits
        credits_handling();
        tickets_handling();
        version_handling()
        // $("#version").html(version);
        loop_data.stamp = new Date().getTime();
      }
      // function next_step() {
      //   save_results(index);
      //   load_question(++index);
      // }
      function next_step() {
        // load_question(++index);
        if(oneoff) {
          save_results(index);
          publish_results(results);
          refresh_building(building_num);
          $(".track-progress").prop("disabled", false);
        } else {
          if(credits <= 0) { alert(`No credits available to continue! Try after some time.`);  return; }
          save_results(index);
          load_question(++index);
        }
        oneoff = false;
      }
      function run_step(question) {
        load_quiz_window();
        quiz.forEach(function(entry, i) { if(entry[0]===question) index=i });
        load_question(index);
        console.log(`load_question(${index})`);
        console.log(`quiz.length=${quiz.length}`);
        oneoff = true;
      }

      function load_quiz(x=0) {
        let avg_level = round(average_level(),1) || 1;
        let this_level = retrieve_progress(x, 'level');
        if(this_level > (avg_level+10)) {
          let msg = `This quiz has reached level ${this_level}, whereas average-level of all your quizes is only ${avg_level}. Difference between these two numbers can not be more than 10. You will need to work on rest of your quizes to raise their levels in order to work on next level of this quiz.`;
          if(!nopopup) alert(msg)
          console.log(msg);
          return false;
        }
        quiz = quizes[x].quiz;
        info = quizes[x].info;
        index = 0;
        load_quiz_window();
        load_question(index);
        building_num = x;
        return true;
      }
      function load_question(index) {
        console.log(`load_question(${index})`);
        clear_form(index);
        if(index > quiz.length-1) return 0;
        let entry = quiz[index]
        let choices = entry[2];
        let question = entry[0], expected = entry[1];
        console.log(`.............................index=${index}`);
        console.log(quiz);
        console.log(entry);
        console.log(question);
        console.log(choices);
        for(let i=0; i<choices.length; i++) {
          $("#choice"+i).text(capitalizeFirstLetter(choices[i]));
        }
        $("#question").text(capitalizeFirstLetter(question));
        if(voice_on) voiceOver.play(entry[3]+1, building_num);
        return 1;
      }
      function clear_form() {
        console.log(`clear_form(${index})`);
        if(index > quiz.length-1) {
          publish_results(results);
          refresh_building(building_num);
          // if(!oneoff) deduct_credit();
          // $("#check-progress").prop("disabled", false);
          // $("#send-progress").prop("disabled", false);
          $(".track-progress").prop("disabled", false);
          return 0;
        }
        let entry = quiz[index]
        let choices = entry[2];
        for(let i=0; i<choices.length; i++) {
          if($("#cbx"+i).prop("checked"))
            $("#btn"+i).click();
        }
        $("#btn-next").prop("disabled", true);
        $("#btn-prev").prop("disabled", true);
        $(".track-progress").prop("disabled", true);
        // $("#check-progress").prop("disabled", true);
        // $("#send-progress").prop("disabled", true);
      }
      function load_quiz_window() {
        console.log(`load_quiz_window()`);
          let results_html = `
              <!-- <h5 class="card-title building-card-title text-center text-white col-8" id="quiz-card-title"><span id="question" style="_padding:200px; color:slategray">Color Green</span></h5> -->
              <div class="row justify-content-center">
                 <!-- <a type="button" class="btn btn-md btn-block btn-link col-8 text-left" style="padding-left:20px"><span style="padding-left:20px">Harra</span></a> -->
                 <h5 class="card-title building-card-title text-left text-white col-8" id="quiz-card-title"><span id="question" style="padding:20px; color:slategray">Color Green</span></h5>
                 <div class="btn-group-vertical col-8" role="group" aria-label="Basic example">
                  <button type="button" class="btn btn-md btn-block btn-light text-left" style="padding-left:20px" id="btn0" onclick="checkbox1(0)"><input id="cbx0" type="checkbox" onclick="checkbox(0)"><span id="choice0" style="padding-left:20px">Harra</span>
                  <button type="button" class="btn btn-md btn-block btn-light text-left" style="padding-left:20px" id="btn1" onclick="checkbox1(1)"><input id="cbx1" type="checkbox" onclick="checkbox(1)"><span id="choice1" style="padding-left:20px">Neela</span>
                  <button type="button" class="btn btn-md btn-block btn-light text-left" style="padding-left:20px" id="btn2" onclick="checkbox1(2)"><input id="cbx2" type="checkbox" onclick="checkbox(2)"><span id="choice2" style="padding-left:20px">Peela</span>
                  <button type="button" class="btn btn-md btn-block btn-light text-left" style="padding-left:20px" id="btn3" onclick="checkbox1(3)"><input id="cbx3" type="checkbox" onclick="checkbox(3)"><span id="choice3" style="padding-left:20px">Kaala</span>
                </div>
              </div>
              <br>
              <div class="row justify-content-center">
                <div class="btn-group col-8" role="group" aria-label="Basic example buttons">
                  <button type="button" class="btn btn-md btn-outline-primary text-primary" id="btn-prev" style="width:20%">Prev</button>
                  <button type="button" class="btn btn-md btn-primary" id="btn-next" style="width:20%" onclick="next_step()">Next</button>
                </div>
              </div>
          `;
          $("#quiz-card-body").html(results_html);
          $("#quiz-card-header-text").text(info.header);
          $("#quiz-card-topic-text").text(info.topic);
          voiceOver.setTopic(info.header);
          // $(window).scrollTop(0);
          window.scrollTo({ top: 0, behavior: 'smooth' });
      }
      function collect_old(id, totid='score-points', i, factor=100) {
          let completion = [233, 133, 33], level = 1;
          let refval = (i!==undefined) ? completion[i] : 0;
          console.log(`0...refval=${refval}, level=${level}`)
          if(refval > factor) { refval -= factor; level++; }
          if(i!==undefined) add_level(i, completion[i]);
          console.log(`1...refval=${refval}, level=${level}`)
          let elem = document.getElementById(id);
          let output = parseInt($(elem).data('prod'));
          elem.style.color = 'lightgray';
          elem.style.fontSize = '24px';
          $(elem).removeClass("btn-light");
          let current_total = parseInt($("#"+totid).text());
          // $("#"+totid).text(current_total+output);
          console.log(output);
          console.log($(elem).data('prod'));
          return output;
      }
      function collect(i, totid='score-points', factor=33) {
          let id = `collect-prod-${i}`;
          let elem = document.getElementById(id);
          let output = parseInt($(elem).data('prod'));
          elem.style.color = 'lightgray';
          elem.style.fontSize = '24px';
          $(elem).removeClass("btn-light");
          let current_total = parseInt($("#"+totid).text());
          $("#"+totid).text(current_total+output);
          store_scorecard('galleons', current_total+output);
          store_progress(i, 'prod', 0);
          store_progress(i, 'coll-time', new Date().getTime());
          console.log(output);
          console.log($(elem).data('prod'));
          return output;
      }
      function collect_level(i, qty=100) {
          if(i===undefined || qty===undefined) return;
          let [total, level] = update_level(i, qty);
          if(total>=100) return [total, level]; // else dim the lights
          let id = `collect-level-${i}`;
          let elem = document.getElementById(id);
          elem.style.color = 'lightgray';
          elem.style.fontSize = '24px';
          $(elem).removeClass("btn-light");
          return [total, level];
      }
      function produce(i, type='prod', src=1) {
          if(src==='debug' && !DEBUG_MODE) return false;
          let id = `collect-prod-${i}`;
          let quiz_level = retrieve_progress(i, 'level') || 1;
          let output = 4 + quiz_level - 1;
          let elem = document.getElementById(id);
          elem.style.color = 'goldenrod';
          elem.style.fontSize = '36px';
          $(elem).addClass("btn-light");
          // output += quiz_level - 1;
          store_progress(i, type, output);
          $(elem).data('prod', output);
          console.log(output);
          console.log($(elem).data('prod'));
      }
      function light_up(i, type='prod') {
          let id = type==='level' ? `collect-level-${i}` : `collect-prod-${i}`;
          let elem = document.getElementById(id);
          elem.style.color = 'goldenrod';
          elem.style.fontSize = '36px';
          $(elem).addClass("btn-light");
      }
      function update_level(i, step=100) {
          if(i===undefined || step===undefined) return;
          let done_id = `#building-${i}-done`
          let level_id = `#building-${i}-level`;
          let level = parseInt($(level_id).text()) || 1;
          let total = parseInt($(done_id).text()) || 0;
          console.log(`0...total=${total}`)
          if(total >= step) {
              total -= step; level++;
              $(done_id).text(total);
              $(level_id).text(level);
              store_progress(i, 'done', total);
              store_progress(i, 'level', level);
          }
          console.log(`1...total=${total}, level=${level}`)
          return [total, level];
      }
      function add_level(i, step=1, src=1) {
          if(src==='debug' && !DEBUG_MODE) return false;
          if(i===undefined || step===undefined) return;
          let level_id = `#building-${i}-level`;
          let level = parseInt($(level_id).text()) || 1;
          console.log(`0...level=${level}`)
          level += step;
          $(level_id).text(level);
          store_progress(i, 'level', level);
          console.log(`1...level=${level}`)
          return level;
      }
      function collect_done(i, addon=0, src=1) {
          if(!addon) addon = 33; // 33% progress for each successful quiz completion
          if(src==='debug' && !DEBUG_MODE) return false;
          if(i===undefined || addon===undefined) return;
          let id = `#building-${i}-done`;
          let total = parseInt($(id).text());
          if(total === undefined) return;
          if(total===66) total += 1;
          if(total%100===66) total += 1;
          total += addon;
          $(id).text(total);
          if(total>=100) light_up(i, type='level');
          store_progress(i, 'done', total);
          deduct_credit();
          return total;
      }
      function reveal_tile(cost=50, scoreid='score-points', revealid='reveal-points') {
          let score_points = parseInt($("#"+scoreid).text());
          let reveal_points = parseInt($("#"+revealid).text());
          if(score_points < cost) {
            alert(`Not enough galleaons!\n  Current total: ${score_points}\n  Required amount: ${cost}`)
            return 0;
          }
          score_points -= cost;
          $("#"+revealid).text(++reveal_points);
          $("#"+scoreid).text(score_points);
          console.log(`score-points = ${score_points}`);
          console.log(`reveal-points = ${reveal_points}`);
          store_scorecard('galleons', score_points);
          store_scorecard('revealers', reveal_points);
          // elem.style.color = 'lightgray';
          // elem.style.fontSize = '24px';
          // $(elem).removeClass("btn-light");
          return 1;
      }
      function load_building(i, quiz, info, {state=1}={}) {
          let results_html = `
              <div class="card-header">
                <div class="row justify-content-center">
                  <h4 class="my-0 font-weight-normal text-center" id="building-${i}-header" debug1 onclick="produce(${i}, 'prod', 'debug')">Colors</h4>
                  <div class="badge badge-light text-muted text-exempt"><span id="building-${i}-count">0</span></div>
                  <!-- <span class="oi oi-flag"></span> -->
                  <!-- <i class="material-icons" style="font-size:48px;">cloud</i> -->
                  <i class="material-icons btn-light" id="collect-prod-${i}" style="font-size:24px;color:lightgray" data-prod="0" onclick="collect(${i}, 'score-points')">card_giftcard</i>
                  <!-- <div class="badge badge-light text-exempt"><h5 id="building-${i}-count2"> 12 </h5></div> -->
                </div>
              </div>
              <div class="card-body pt-1">
                <!-- <h4 class="card-title building-card-title"><span class="text-muted">Level</span> 1</h4> -->
                <ul class="list-unstyled mb-0">
                  <!-- <li><span id="building-${i}-count">0</span> items</li> -->
                  <!-- <li><small class="text-muted">Avg 3</small><small class="text-muted">, Min 2</small></li> -->
                  <!-- <li><em class="text-muted text-exempt">Level 1</em></li> -->

                  <li class="text-center"><em class="text-muted text-exempt" debug1 onclick="add_level(${i}, 1, 'debug');">Level <span id="building-${i}-level">1</span></em>
                  <i class="material-icons btn-light" id="collect-level-${i}" style="font-size:24px;color:lightgray;" data-prod="0" onclick="collect_level(${i}, 100)">school</i></li>
                  <li class="text-center"><h6 class="text-muted text-exempt" debug1 onclick="collect_done(${i}, 0, 'debug')"><span id="building-${i}-done">0</span>% done</h6></li>
                </ul>
                <button type="button" class="btn btn-link btn-block track-progress" id="building-${i}-progress-btn" onclick="check_progress(${i})">Check Progress</button>
                <hr>
                <button type="button" class="btn btn-lg btn-block btn-outline-primary text-primary" id="building-${i}-start-btn" onclick="load_quiz(${i})">Start</button>
            </div>
          `;
            // <div class="col mb-4">
            // </div>

          let building_column = document.createElement("div");
          building_column.className = "col mb-2";
          $("#quiz-buildings").append(building_column);
          let building = document.createElement("div");
          building.className = "card mb-4 shadow-sm";
          building.innerHTML = results_html;
          // $(building).addClass('shrink60');
          $(building_column).append(building);
          // $("#quiz-buildings").append(building);
          $(`#building-${i}-header`).text(info.header);
          $(`#building-${i}-count`).text(quiz.length);
          // version_handling(i)
          let quiz_level = retrieve_progress(i, 'level') || 1;
          let quiz_done = retrieve_progress(i, 'done') || 0;
          // if(quiz_level===1 && quiz_done<100 && i<3) quiz_done = 100; // one time bump for their work done in earlier version
          if(quiz_level>=2) max_level2_plus_reached++;
          if(quiz_level>=3) max_level3_plus_reached++;
          let {db, report, results} = get_progress(i);
          console.log({db, report, results});
          // quiz_done = Math.round(report.summary.attempts/3 * 100) || 0;
          $(`#building-${i}-level`).text(quiz_level);
          $(`#building-${i}-done`).text(quiz_done);
          if(quiz_done>=100) light_up(i, type='level');
          let quiz_prod = retrieve_progress(i, 'prod');
          if(quiz_prod) produce(i, type='prod');
          let coll_time = retrieve_progress(i, 'coll-time');
          if(!coll_time && state===1) store_progress(i, 'coll-time', new Date().getTime());
          // fade buildings in ruin
          if(state<1) disable_appearance(building, {disable: true, opacity: state>0?0.3:0.1});
          if(state<1) disable_appearance(`#building-${i}-progress-btn`, {disable: true, opacity: state>0?0.2:0.1});
          if(state<1) disable_appearance(`#building-${i}-start-btn`, {disable: true, opacity: state>0?0.1:0.1});
      }
      function refresh_building(i, quiz, info) {
          let quiz_level = retrieve_progress(i, 'level') || 1;
          let quiz_done = retrieve_progress(i, 'done') || 0;
          if(quiz_level===1 && quiz_done<100 && i<3) quiz_done = 100; // one time bump for their work done in earlier version
          if(quiz_level>=2) max_level2_plus_reached++;
          if(quiz_level>=3) max_level3_plus_reached++;
          let {db, report, results} = get_progress(i);
          console.log({db, report, results});
          // quiz_done = Math.round(report.summary.attempts/3 * 100) || 0;
          $(`#building-${i}-level`).text(quiz_level);
          $(`#building-${i}-done`).text(quiz_done);
          if(quiz_done>=100) light_up(i, type='level');
      }
      // function refresh_building(i, quiz, info) {
      //     // let quiz_level = 1, quiz_done = 33;
      //     let quiz_level = retrieve_progress(i, 'level');
      //     let quiz_done = retrieve_progress(i, 'done');
      //     let {db, report, results} = get_progress(i);
      //     console.log({db, report, results});
      //     quiz_done = Math.round(report.summary.attempts/3 * 100) || 0;
      //     quiz_done = Math.round(report.summary.attempts/3 * 100);
      //     console.log(`quiz_done = ${quiz_done}`);
      //     $(`#building-${i}-level`).text(quiz_level);
      //     $(`#building-${i}-done`).text(quiz_done);
      // }
      function version_handling() {
          // store_scorecard("version", undefined)
          console.log(`... version_handling()`);
          let version = retrieve_scorecard("version") || 0;
          console.log(`... version was set to ${version}`)
          if(version < 0.6) {
              console.log(`... version was previously set to ${version}, upgrading to 0.6`)
              let reset_scores = [];
              for(let i=0; i<quizes.length; i++) {
                  // if(i>MAX_QUIZES-1) continue;
                  let quiz_level = retrieve_progress(i, 'level') || 1;
                  let quiz_done = retrieve_progress(i, 'done') || 0;
                  console.log(`0... i=${i}, quiz_level=${quiz_level}, quiz_done=${quiz_done}, MAX_QUIZES=${MAX_QUIZES}`)
                  reset_scores.push({ quiz_level: 0, quiz_done: 0 })
                  if(i<3) { reset_scores[i].quiz_level = 5 } // one time bump for their work done in earlier version
                  if(quiz_level>=5 && i<MAX_QUIZES) { reset_scores[i].quiz_level = 5 } // one time bump for their work done in earlier version
                  switch(user.id) {
                      case 'pgill18' : if(i<3) reset_scores[i].quiz_level = 6; break;
                      case 'darshanbal' : if(i<3) reset_scores[i].quiz_level = 6; break;
                      case 'eshaangill12' : if(i<3) reset_scores[i].quiz_level = 2; break;
                      case 'jaydhillon2017' : if(i<3) reset_scores[i].quiz_level = 5; break;
                      case 'vikdhillon2017' : if(i<3) reset_scores[i].quiz_level = 5; break;
                      case 'jay' : if(i<3) reset_scores[i].quiz_level = 5; break;
                      case 'vik' : if(i<3) reset_scores[i].quiz_level = 5; break;
                  }
              }
              alert(`A new version of this app is available. This requires you to clear local storage. Reload this page after Clear Local Storage to continue properly.`);
              if(confirm(`Clear Local Storage?`)) {
                  clear_local_storage();
                  version = 0.6;
                  let galleons = 60, population = 0;
                  switch(user.id) {
                      case 'pgill18' : galleons=92; population=0; break;
                      case 'darshanbal' : galleons=96; population=0; break;
                      case 'eshaangill12' : galleons=60; population=0; break;
                      case 'jaydhillon2017' : galleons=60; population=0; break;
                      case 'vikdhillon2017' : galleons=60; population=0; break;
                      case 'jay' : galleons=60; population=0; break;
                      case 'vik' : galleons=60; population=0; break;
                  }
                  console.log(`user: `, user)
                  console.log(`user-id: `, user.id)
                  store_scorecard("version", version)
                  store_scorecard("galleons", galleons)
                  store_scorecard("population", 0) // old key
                  store_scorecard("population/total", population)
                  console.log(`============= reset_scores = `, reset_scores);
                  for(let i=0; i<reset_scores.length; i++) {
                      store_progress(i, 'level', reset_scores[i].quiz_level);
                      store_progress(i, 'done', reset_scores[i].quiz_done);
                      console.log(`1... i=${i}, quiz_level=${reset_scores[i].quiz_level}, quiz_done=${reset_scores[i].quiz_done}`)
                  }
                  window.location.reload(false);
              }
          }
          if(version < VERSION) {
              console.log(`... version was previously set to ${version}, upgrading ${VERSION}`)
              version = VERSION
              store_scorecard("version", version)
          }
          $("#version").html(version);
          console.log(`... version is set to ${version}`)
      }
      function credits_handling(initialize=1, speedup=1) {
          let avg_level = average_level() || 1;
          let curr_time = new Date().getTime();
          let max_credits = 10 + Math.ceil(avg_level) - 1;
          let read_credits = retrieve_scorecard('credits');
          let coll_time = retrieve_scorecard('credit-coll-time');
          let duration = 1*60*60*1000; // New credit every 1 hour
          if(speedup>1) duration = Math.round(duration/speedup);
          // console.log(`credits=${credits}, max_credits=${max_credits}, read_credits=${read_credits}, credits_coll_time=${coll_time}`);
          if(read_credits===undefined || coll_time===undefined) {
              credits = max_credits;
              coll_time = curr_time;
              store_scorecard('credits', credits);
              store_scorecard('credit-coll-time', coll_time);
              // $("#credits").html(credits);
          }
          else if(read_credits!==read_credits || coll_time!==coll_time) { // NaN scenario
              credits = max_credits;
              coll_time = curr_time;
              store_scorecard('credits', credits);
              store_scorecard('credit-coll-time', coll_time);
              // $("#credits").html(credits);
          } 
          else if(curr_time >= coll_time+duration) { // add new credit
              if(read_credits < max_credits) {
                  let new_credits = Math.floor((curr_time-coll_time)/duration);
                  credits = read_credits + new_credits;
                  if(credits > max_credits) credits = max_credits;
                  store_scorecard('credits', credits);
                  store_scorecard('credit-coll-time', curr_time);
                  console.log(`Added ${new_credits} new credit(s) (Max ${max_credits}). Total credits set to  ` + credits);
              } else {
                  credits = read_credits;
              }
          } else if(initialize) { // run at site loading
              credits = read_credits;
          }
          $("#credits").html(credits);
      }
      function deduct_credit() {
          store_scorecard('credits', --credits);
          $("#credits").html(credits);
      }
      function average_level() {
          let quiz_status = [];
          for(let i=0; i<quizes.length; i++) {
              // if(i>MAX_QUIZES-1) continue;
              let level = retrieve_progress(i, 'level');
              let done = retrieve_progress(i, 'done');
              let prod = retrieve_progress(i, 'prod');
              // console.log(`quiz... i=${i}, level=${level}, prod=${done}, prod=${done}, MAX_QUIZES=${MAX_QUIZES}`)
              quiz_status.push({ level: level || 1, done: done || 0, prod: prod || 0 })
          }
          let sum_levels = quiz_status.map(qs => qs.level).reduce((a,b) => a+b,0);
          return sum_levels ? sum_levels/quiz_status.length : 1;
      }
      async function loop() {
          console.log(`entering the loop() ...`, new Date().toLocaleString());
          console.log(MAX_QUIZES)
          // console.log(quizes)
          let one_period = 24*60*60*1000; // one day in ms
          if(speedup>1) one_period = Math.round(one_period/speedup);
          // let one_period = 10* 60*1000; // one day in ms
          // let period = 1;
          for(let i=0; i<MAX_QUIZES; i++) {
              if(!quizes[i]) continue;
              let curr_time = new Date().getTime();
              let coll_time = parseInt(retrieve_progress(i, 'coll-time'));
              // console.log(`i=${i} curr_time = ${curr_time}, coll_time = ${coll_time}`);
              // if(!coll_time) continue;
              if(!coll_time || curr_time > coll_time+one_period) {
                  if(states[i]===1) produce(i, type='prod');
              }
              let elapsed_time = (curr_time - coll_time);
              // console.log(`i=${i} curr_time = ${curr_time}, coll_time = ${coll_time}, elapsed = ${elapsed_time/1000/60}, ratio = `, one_period/elapsed_time);
              let quiz_done = retrieve_progress(i, 'done');
              if(quiz_done>=100) light_up(i, type='level');
          }
          let curr_time = new Date().getTime();
          loop_data.hour = Math.floor((curr_time-loop_data.stamp)/(one_period/24));
          if((curr_time-loop_data.stamp) >= one_period) {
              loop_data.day++;
              loop_data.hour = 0;
              loop_data.stamp = curr_time;
          }
          loop_data.minute = Math.floor((curr_time-loop_data.stamp)/(one_period/24/60)) - loop_data.hour*60;
          // if((curr_time-loop_data.stamp) >= one_period/24) {
          //     loop_data.hour++;
          // }
          console.log(`curr_time = ${curr_time}, loop_data.stamp = ${loop_data.stamp}`)
          console.log(`one_period = ${one_period}, curr_time-loop_data.stamp = ${curr_time-loop_data.stamp}`)
          tickets_handling(0, speedup);
          credits_handling(0, speedup);
          if(automagic) {
              if(speedup > 3600) {
                  await run_automagic(one_period, speedup);
              } else if(oncredit && credits>=1) { // everytime a credit is available
                  await run_automagic(one_period, speedup);
              } else if(speedup >= 360 && credits >= 6) {
                  await run_automagic(one_period, speedup);
              } else if(speedup >= 60 && credits >= 6) {
                  await run_automagic(one_period, speedup);
              } else if(speedup < 60) { // schedule
                  if(loop_data.hour === 6 || loop_data.hour === 16 || loop_data.hour === 22 || credits >= 10)
                      await run_automagic(one_period, speedup);
              } else if (credits >= 10) {
                  await run_automagic(one_period, speedup);
              }
          }
          console.log(`day ${loop_data.day},    hour ${loop_data.hour},    minute ${loop_data.minute}`)
          // let loopwait = 10*1000; // loops every 10 seconds
          // if(speedup>1) loopwait = 1000; // fastest can go 1 sec maybe?
          // setTimeout(() => loop(), loopwait); // runs in a loop every 30 seconds
      }
      async function run_automagic(one_period, _speedup) {
          if(accelerate>1) _speedup = accelerate;
          console.log(`... run_automagic(one_period = ${one_period}, speedup = ${_speedup})`);
          for(let i=0; i<MAX_QUIZES; i++) {
              if(!quizes[i]) continue;
              if(states[i] < 1) continue;
               // collect galleons
              console.log(i, $(`#collect-prod-${i}`).css('color'))
              if($(`#collect-prod-${i}`).css('color') === 'rgb(218, 165, 32)') { // goldenrod
                  $(`#collect-prod-${i}`).click();
                  console.log(`automagically clicking collect-prod-${i}`);
              }
              // take a quiz (if credits available)
              if(credits > 0) {
                  console.log(`... starting quiz ${i}, ` + quizes[i].info)
                  // click start quiz
                  // $(`#building-${i}-start-btn`).click();
                  if(!load_quiz(i)) continue;
                  // click next button until it's disabled
                  let quiz = quizes[i].quiz;
                  console.log(`quiz.length = ${quiz.length}`);
                  for(let j=0; j<quiz.length; j++) {
                      await delay(1, _speedup);
                      let entry = quiz[j];
                      let choices = entry[2];
                      let expected = entry[1];
                      let iex = choices.indexOf(expected) || 0;
                      if(random(1,10)==1) iex = random(0, choices.length-1);
                      checkbox1(iex);
                      // $(`btn${i}`).click();
                      next_step();
                      // $("btn-next").click();
                      console.log(`question = ${entry[0]}, answer = ${expected}`)
                  }
                  await delay(0.1, _speedup);
                  collect_level(i);
              }
          }
      }
      function delay(seconds, speedup=1) {
          return new Promise(resolve => setTimeout(resolve, seconds*1000/speedup));
      }
      function round(num, digits=0) {
          let factor = Math.pow(10, digits);
          return Math.round(num*factor)/factor;
      }
      function random(min, max, round=0) {
          let number = Math.random() * (max - min) + min;
          let rounder = Math.pow(10, round);
          return round===0 ? Math.round(number) : Math.round(number*rounder)/rounder;
      }

      function load_scorecard() {
          // let population = retrieve_scorecard(`population/total`) || 0;
          let galleons = retrieve_scorecard("galleons") || 0;
          // let reveal_points = retrieve_scorecard("revealers") || 0;
          $("#score-points").text(galleons);
          // $("#reveal-points").text(reveal_points);
          // $("#total-population").text(population);
      }

      function store_progress(i, key, value) {
        let pathkey = `${info.project}/${info.section}/${info.topic}`;
        if(i !== undefined) {
          let info = quizes[i].info;
          pathkey = `${info.project}/${info.section}/${info.topic}`;
        }
        let db = window.localStorage.getItem(user.id);
        // console.log(db);
        if(!db) db = {}; else db = JSON.parse(db);
        if(!db[pathkey]) db[pathkey] = {};
        if(!db[pathkey].progress) db[pathkey].progress = {prod:0, done:0, level:1}
        db[pathkey].progress[key] = value;
        // console.log(db);
        window.localStorage.setItem(user.id, JSON.stringify(db));
      }
      function store_scorecard(key='galleons', value=0) {
        let pathkey = `${info.project}`;
        let db = window.localStorage.getItem(user.id);
        // console.log(db);
        if(!db) db = {}; else db = JSON.parse(db);
        if(!db[pathkey]) db[pathkey] = {};
        if(!db[pathkey].scorecard) db[pathkey].scorecard = {};
        db[pathkey].scorecard[key] = value;
        // console.log(db);
        window.localStorage.setItem(user.id, JSON.stringify(db));
      }
      function retrieve_progress(i=0, key) {
        // console.log(`retrieve_progress(${i}, ${key})`)
        let pathkey = `${info.project}/${info.section}/${info.topic}`;
        if(i !== undefined) {
          let info = quizes[i].info;
          pathkey = `${info.project}/${info.section}/${info.topic}`;
        }
        let db = window.localStorage.getItem(user.id);
        // console.log(db);
        // console.log(`0retrieve_progress(${i}, ${key}): ${pathkey}`)
        // console.log(user.id);
        // console.log(db);
        if(!db) db = {}; else db = JSON.parse(db);
        if(!db[pathkey]) return;
        // console.log(`1retrieve_progress(${i}, ${key})`)
        if(!db[pathkey].progress) return;
        // console.log(`2retrieve_progress(${i}, ${key})`)
        if(key===undefined) return db[pathkey].progress;
        // console.log(db[pathkey].progress)
        // console.log(db[pathkey].progress[key])
        // console.log(db);
        return db[pathkey].progress[key];
      }
      function retrieve_scorecard(key) {
        let pathkey = `${info.project}`;
        let db = window.localStorage.getItem(user.id);
        // console.log(db);
        if(!db) db = {}; else db = JSON.parse(db);
        if(!db[pathkey]) return;
        if(!db[pathkey].scorecard) return;
        if(key===undefined) return db[pathkey].scorecard;
        return db[pathkey].scorecard[key];
      }

      function disable_appearance(element, opt) {
        $(element).prop("disabled", opt.disable);
        $(element).css({opacity: opt.opacity});
      }
      function passing_grade(i, score, count) {
          console.log(`... passing_grade(i=${i}, score=${score}, count=${count})`);
          let quiz_level = retrieve_progress(i, 'level');
          let passpc = !quiz_level ? 50 : 50 + quiz_level*5;
          if(passpc > 90) passpc = 90;
          console.log(`... passing_grade(}: quiz_level=${quiz_level}, passpc=${passpc}, pass? = ${(score >= count*passpc/100)})`);
          return (score >= count*passpc/100);
      }
      function publish_results(results) {
          $("#quiz-card-title").html('Results');
          let results_html = '';
          let tablerows = '';
          let score = 0;
          for(let i=0; i<results.length; i++) {
            let {question, expected, answer, pass, choices} = results[i];
            let passfail = pass ? "PASSED" : "FAILED";
            if(pass) score++;
            question = capitalizeFirstLetter(question);
            expected = capitalizeFirstLetter(expected);
            answer = capitalizeFirstLetter(answer);
            // results_html += '<li>' + JSON.stringify(results[i]) + '</li>';
            // let bgcolor = pass ? "lightgreen" : "lightsalmon";
            let bgcolor = pass ? "#ABEBC6" : "#fdd0cb";
            // tablerows += `<tr style="background-color: ${bgcolor}" href="#"  onclick="check_progress()">\n<td  onclick="check_progress()">${question}</td>\n<td>${expected}</td>\n<td>${answer}</td>\n<td>${passfail}</td>\n<tr>`
            tablerows += `<tr style="background-color: ${bgcolor}">\n`;
            for(let field of [question, expected, answer, passfail]) {
              tablerows += `<td><a style="cursor: pointer;" onclick="run_step('${question}');">${field}</a></td>\n`;
            }
            tablerows += `</tr>`;
          }
          // results_html = `<ul>${results_html}</ul>`;
          results_html = `
            <table id="classTable" class="table table-bordered table-sm">
              <thead>
                <th>Question</th><th>Answer</th><th>Your Answer</th><th>Result</th>
              </thead>
              <tbody>
                ${tablerows}
              </tbody>
            </table>
          `;
          // results_html = JSON.stringify(results);
          $("#quiz-card-body").html(results_html);
          console.log(JSON.stringify(results));
          store_results(results);
          if(passing_grade(building_num, score, results.length)) collect_done(building_num);
      }
      function publish_report(report) {
          if(!report || !report.table) return;
          $("#quiz-card-title").html('Results');
          let report_html = '';
          let tablerows = '';
          for(let i=0; i<report.table.length; i++) {
            let {question, expected, correct, incorrect, choices} = report.table[i];
            question = capitalizeFirstLetter(question);
            expected = capitalizeFirstLetter(expected);
            let confidence = incorrect===0 ? 100 : Math.round(correct/(correct+incorrect)*100);
            // let bgcolor = correct>incorrect ? "lightgreen" : "lightsalmon";
            let bgcolor = correct>incorrect ? "#ABEBC6" : "#fdd0cb";
            tablerows += `<tr style="background-color: ${bgcolor}"  onclick="check_progress()">\n<td>${question}</td>\n<td>${expected}</td>\n<td>${correct}</td>\n<td>${incorrect}</td>\n<td>${confidence}</td>\n<tr>`
            // tablerows += `<tr style="background-color: ${bgcolor}">\n`;
            // for(let field of [question, expected, correct, incorrect, confidence]) {
            //   tablerows += `<td><a style="cursor: pointer;" onclick="run_step('${question}')">${field}</a></td>\n`;
            // }
            // tablerows += `</tr>`;
          }
          // results_html = `<ul>${results_html}</ul>`;
          report_html = `
            <table id="classTable" class="table table-bordered table-sm">
              <thead>
                <th>Question</th><th>Answer</th><th>Correct count</th><th>Incorrect count</th><th>Confidence %</th>
              </thead>
              <tbody>
                ${tablerows}
              </tbody>
            </table>
          `;
          // results_html = JSON.stringify(results);
          $("#quiz-card-body").html(report_html);
          console.log(JSON.stringify(results));
          // store_results(results);
      }
      function generate_report(all_results) {
        let report = {table: [], summary: {count: 0, attempts: 0, correct: 0, incorrect: 0}};
        let index_lookup = {};
        for(let results of all_results) { // all attempts
          for(let i=0; i<results.length; i++) { // ith question
            let {question, expected, answer, pass, choices} = results[i];
            if(index_lookup[question]===undefined) index_lookup[question] = i;
            let index = index_lookup[question];
            let correct = (report.table[index] && report.table[index].correct) ? report.table[index].correct : 0;
            let incorrect = (report.table[index] && report.table[index].incorrect) ? report.table[index].incorrect : 0;
            if(pass) correct++; else incorrect++;
            if(pass) report.summary.correct++; else report.summary.incorrect++;
            report.table[index] = {question, expected, correct, incorrect, choices};
          }
          report.summary.count = results.length;
        }
        report.summary.attempts = all_results.length;
        return report;
      }
      function store_results(results) {
        let pathkey = `${info.project}/${info.section}/${info.topic}`;
        let db = window.localStorage.getItem(user.id);
        // console.log(db);
        if(!db) db = {}; else db = JSON.parse(db);
        if(!db[pathkey]) db[pathkey] = {};
        if(!db[pathkey].report) db[pathkey].report = {table: [], summary: {}};
        if(!db[pathkey].results) db[pathkey].results = [];
        if(!db[pathkey].progress) db[pathkey].progress = {done: 0, level: 1};
        if(!db[pathkey].scorecard) db[pathkey].scorecard = {galleons: 0, revealers: 0};
        // db[pathkey].results.push(results);
        if(oneoff) {
          db[pathkey].results[db[pathkey].results.length-1] = results;
        } else {
          db[pathkey].results.push(results);
          let marks = results.map(res => res.pass ? 1 : 0).reduce((a,b) => a+b,0);
          if(marks >= results.length/2) db[pathkey].progress['done'] += 33; // passed
        }
        db[pathkey].report = generate_report(db[pathkey].results);
        console.log(db);
        window.localStorage.setItem(user.id, JSON.stringify(db));
      }
      function retrieve_results(i) {
        let pathkey = `${info.project}/${info.section}/${info.topic}`;
        if(i !== undefined) {
          let info = quizes[i].info;
          pathkey = `${info.project}/${info.section}/${info.topic}`;
        }
        let db = window.localStorage.getItem(user.id);
        // console.log(db);
        if(!db) db = {}; else db = JSON.parse(db);
        if(!db[pathkey]) db[pathkey] = {};
        if(!db[pathkey].report) db[pathkey].report = {table: [], summary: {}};
        if(!db[pathkey].results) db[pathkey].results = [];
        console.log(`i = ${i},  building_num = ${building_num}`);
        console.log(`pathkey = ${pathkey}`);
        console.log(db);
        return {db, report: db[pathkey].report, results: db[pathkey].results};
      }
      function check_progress(i) {
        // window.localStorage.clear();
        // window.localStorage.setItem(user.id, "");
        console.log(window.localStorage);
        let {db, report, results} = retrieve_results(i);
        console.log(report);
        publish_report(report);
        oneoff = false;
      }
      function get_progress(i) {
        let {db, report, results} = retrieve_results(i);
        return {db, report, results};
      }
      function clear_local_storage() {
        window.localStorage.clear();
        set_user(user);
        // window.location.reload(false);
      }
      function capitalizeFirstLetter(string) {
        return string.charAt(0).toUpperCase() + string.slice(1);
      }
      function load_user() {
        let user_data = window.localStorage.getItem('user');
        user_data = JSON.parse(user_data);
        user.name = user_data.name;
        user.email = user_data.email;
        user.id = user_data.id;
        console.log(user);
        return user;
      }
      function set_user(user) {
        if(!user || !user.id) user = load_user();
        console.log(user);
        window.localStorage.setItem('user', JSON.stringify(user));
        let firstname = user.name.replace(/(\w+)\s.*/, '$1'); // display only first name
        $("#user").text(firstname);
      }
      function signin_user(user) {
        if(window.localStorage.getItem('user')) {
          set_user(user); return;
        }
        sigup_modal();
      }

      function save_results(index) {
        if(index > quiz.length-1) return 0;
        let entry = quiz[index]
        let choices = entry[2];
        let question = entry[0], expected = entry[1], answer;
        for(let i=0; i<choices.length; i++) {
          console.log(`.....${i} ` + $("#cbx"+i).prop("checked"))
          if($("#cbx"+i).prop("checked")) {
            $("#cbx"+i).prop("checked", false);
            // console.log('.....yeaah')
            answer = choices[i]; break;
          }
        }
        let pass = (answer===entry[1]);
        console.log(pass?'PASSED':'FAILED');
        let result = {question, expected, answer, pass, choices};
        results[index] = result;
        console.log(results);
      }

      function checkbox(i) {
        $("#btn"+i).click();
        $("#btn-next").prop("disabled", false);
      }
      function checkbox1(i) {
        $("#cbx"+i).prop("checked", ! $("#cbx"+i).prop("checked"));
        $("#btn-next").prop("disabled", false);
        // automatically press "Next" if cleared first level
        if(!building_num && building_num!==0) return;
        let this_level = retrieve_progress(building_num, 'level');
        if(this_level>=1 && !automagic) {
          // $("#btn"+i).button('toggle'); // remove active state
          next_step();
        }
      }

      function download_progress() {
        var button = document.getElementById('send-progress');
        if(button.textContent!=='Send Progress') {
          button.textContent = "Send Progress";
          return;
        }
        let obj = window.localStorage.getItem(user.id);
        let data = "text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(obj, null, 2));
        var a = document.createElement('a');
        a.href = 'data:' + data;
        a.download = 'data.json';
        a.innerHTML = 'Download';
        button.textContent = "";
        button.appendChild(a);
      }
    </script>

    </div>
      <div class="container">
        <div class="card-deck mb-3 text-center">
          <div class="card mb-4 shadow" id="quiz-card">
            <div class="card-header bg-light text-muted" id="quiz-card-header">
              <h4 class="my-0 font-weight-normal" id="quiz-card-header-text">Colors</h4>
            </div>
            <div class="card-body" id="quiz-card-body">
              <h5 class="card-title building-card-title text-left text-muted" id="quiz-card-title"><span id="question" style="padding:200px; color:slategray">Color Green</span></h5>
              <div class="row justify-content-center">
                <div class="btn-group-vertical col-8" role="group" aria-label="Basic example">
                  <button type="button" class="btn btn-md btn-block btn-light text-left" style="padding-left:20px" id="btn0" onclick="checkbox1(0)"><input id="cbx0" type="checkbox" onclick="checkbox(0)"><span id="choice0" style="padding-left:20px">Harra</span>
                  <button type="button" class="btn btn-md btn-block btn-light text-left" style="padding-left:20px" id="btn1" onclick="checkbox1(1)"><input id="cbx1" type="checkbox" onclick="checkbox(1)"><span id="choice1" style="padding-left:20px">Neela</span>
                  <button type="button" class="btn btn-md btn-block btn-light text-left" style="padding-left:20px" id="btn2" onclick="checkbox1(2)"><input id="cbx2" type="checkbox" onclick="checkbox(2)"><span id="choice2" style="padding-left:20px">Peela</span>
                  <button type="button" class="btn btn-md btn-block btn-light text-left" style="padding-left:20px" id="btn3" onclick="checkbox1(3)"><input id="cbx3" type="checkbox" onclick="checkbox(3)"><span id="choice3" style="padding-left:20px">Kaala</span>
                </div>
              </div>
              <br>
              <div class="row justify-content-center">
                <div class="btn-group col-8" role="group" aria-label="Basic example buttons">
                  <button type="button" class="btn btn-md btn-outline-primary text-primary" id="btn-prev" style="width:20%">Prev</button>
                  <button type="button" class="btn btn-md btn-primary" id="btn-next" style="width:20%" onclick="next_step()">Next</button>
                </div>
              </div>
            </div>
          </div>
        </div>

      <!--        
      <div class="squares-header px-3 py-3 pt-md-5 pb-md-4 mx-auto text-center">
        <div class="card mb-4 shadow-sm">
          <div class="card-body">
            <div class="row row-cols-1 row-cols-md-2">
              <button type="button" class="btn btn-md btn-light col-5 track-progress" onclick="check_progress()" id="check-progress">Check Progress</button>
              <button type="button" class="btn btn-md btn-light col-5 track-progress" onclick="download_progress()" id="send-progress">Send Progress</button>
              <button type="button" class="btn btn-md btn-light progress" onclick="clear_local_storage()" id="clear_storage">Clear local storage</button>
            </div>
          </div>
        </div>
      </div> -->
 
      <!-- <div class="squares-header px-3 py-3 pt-md-5 pb-md-4 mx-auto text-center"> -->
      <div class="text-center">
        <div class="card mb-0 shadow-sm">
          <div class="card-body py-2">
              <div class="row row-cols-1 row-cols-md-2 justify-content-center">
                <div class="btn-group" role="group" aria-label="Basic example buttons">
                  <button type="button" class="btn btn-md btn-light track-progress" onclick="check_progress()" id="check-progress">Check Progress</button>
                  <button type="button" class="btn btn-md btn-light track-progress" onclick="download_progress()" id="send-progress">Send Progress</button>
                </div>
              </div>
          </div>
        </div>
      </div>

      <div class="squares-header px-3 py-3 pt-md-5 pb-md-4 mx-auto text-center">
        <!-- <h3 class="display-5">Colors</h3> -->
        <p class="lead" debug1 onclick="add_galleons('50', 'debug')">Current points: <em id="score-points" class="text-muted">0<em></p>
      </div>

      <div class="container">
        <!-- <div class="card-deck mb-3 text-center grid"> -->
          <div class="row row-cols-1 row-cols-md-3" id="quiz-buildings">
          </div>
        <!-- </div> -->
      </div>

      <div class="squares-header px-3 py-3 pt-md-5 pb-md-4 mx-auto text-center">
        <!-- <h3 class="display-5">Colors</h3> -->
        <!-- <p class="lead" onclick1="reveal_tile()" hidden>Revealed: <em id="reveal-points" class="text-muted">0<em></p> -->
        <a class="lead col text-muted" onclick1="reveal_tile()">Population: <em id="total-population" class="text-muted">0<em></a>
        <a class="lead col text-muted" onclick1="reveal_tile()">Enrolled: <em id="total-enrolled" class="text-muted">0<em></a>
        <a class="lead col text-muted" onclick1="reveal_tile()">Tickets: <em id="total-tickets" class="text-muted">0<em></a>
      </div>

      <div class="container col-10" style="position:relative; height: 800px;">
        <!-- <img src="punjab.jpg" class="card-img-top" alt="..." style="position:absolute; top:0; left:0;"> -->
        <div class="card-group" id="map-grid" style="position:absolute; top:0; left:0; background-image: url('punjab.jpg'); background-size: 100% 100%; background-repeat: no-repeat">
        </div>
      </div>

      <script>
          $(() => {
              add_map(5, 5);
          });
          function deduct_galleons(cost=50) {
              console.log(`Deducting ${cost} Galleons!`);
          }
          function add_galleons(value=50, src=1) {
              if(src==='debug' && !DEBUG_MODE) return false;
              value = parseInt(value);
              console.log(`value=${value}`);
              let galleons = retrieve_scorecard("galleons") || 0;
              store_scorecard(`galleons`, galleons+value);
              $("#score-points").text(galleons+value);
          }
          function collect_map_space(i, j, cost=50) {
              let space = document.getElementById(`space-${i}-${j}`);
              let revealed = retrieve_scorecard(`tiles/space-${i}-${j}`);
              if(revealed) { return populate_tile(i, j); }
              // if(revealed) return;
              if(confirm(`This will cost ${cost} galleons, are you sure?`)) {
                  if(reveal_tile(cost)) {
                      space.innerHTML = add_grid_cell(i, j, `${i}${j}`, true);
                      space.style.opacity = 0.7;
                      store_scorecard(`tiles/space-${i}-${j}`, 1);
                      let tilenum = (i+1)*(j+1);
                      let population = 150 - Math.abs(13-tilenum)*10/2;
                      mapdata.population += population;
                      $("#total-population").text(mapdata.population);
                      store_scorecard(`population/space-${i}-${j}`, population);
                      store_scorecard(`population/total`, mapdata.population);
                      discovered_population(i, j, population);
                  }
              }
          }
          function discovered_population(i, j, count) {
              alert(`Congratulations! You just discovered a new population of ${count}. Now you have total population of ${mapdata.population}. You need to discover total poplation of 200 to start this next step. Continue uncovering new spaces until you reach this critical mass. Then you can start construction and build your civilization.`);
          }
          function populate_tile(i, j) {
              alert(`You need to discover total poplation of 200 to start this next step. So far you have discovered total population of ${mapdata.population}. Continue uncovering new spaces until you reach this critical mass. Then you can start construction and build your civilization.`);
          }
          function add_map(xn, yn, ncol) {
              let container = document.getElementById('map-grid');
              for(let j=0; j<xn; j++) {
                  row_element = document.createElement('div');
                  row_element.className = `row col-12`;
                  container.appendChild(row_element);
                  for(let i=0; i<yn; i++) {
                      let revealed = retrieve_scorecard(`tiles/space-${i}-${j}`);
                      let cell_html = add_grid_cell(i, j, `${i}${j}`, revealed);
                      cell_element = document.createElement('div');
                      cell_element.className = 'card col m-0 p-0';
                      cell_element.id = `space-${i}-${j}`;
                      // cell_element.style.opacity = `0.5`;
                      cell_element.innerHTML = cell_html;
                      row_element.appendChild(cell_element);
                      if(revealed) cell_element.style.opacity = 0.7;
                  }
              }
          }

          function tickets_handling(initialize=1, speedup=1) {
              let tickets = mapdata.tickets;
              let avg_level = average_level() || 1;
              let curr_time = new Date().getTime();
              let max_tickets = 10 + Math.ceil(avg_level) - 1;
              let read_tickets = retrieve_scorecard('tickets');
              let coll_time = retrieve_scorecard('ticket-coll-time');
              let duration = 1*60*60*1000; // New ticket every 1 hour
              if(speedup>1) duration = Math.round(duration/speedup);
              // console.log(`tickets=${tickets}, max_tickets=${max_tickets}, read_tickets=${read_tickets}, tickets_coll_time=${coll_time}`);
              if(read_tickets===undefined || coll_time===undefined) {
                  tickets = max_tickets;
                  coll_time = curr_time;
                  store_scorecard('tickets', tickets);
                  store_scorecard('ticket-coll-time', coll_time);
                  // $("#tickets").html(tickets);
              }
              else if(read_tickets!==read_tickets || coll_time!==coll_time) { // NaN scenario
                  tickets = max_tickets;
                  coll_time = curr_time;
                  store_scorecard('tickets', tickets);
                  store_scorecard('ticket-coll-time', coll_time);
                  // $("#tickets").html(tickets);
              } 
              else if(curr_time >= coll_time+duration) { // add new ticket
                  if(read_tickets < max_tickets) {
                      let new_tickets = Math.floor((curr_time-coll_time)/duration);
                      tickets = read_tickets + new_tickets;
                      if(tickets > max_tickets) tickets = max_tickets;
                      store_scorecard('tickets', tickets);
                      store_scorecard('ticket-coll-time', curr_time);
                      console.log(`Added ${new_tickets} new ticket(s) (Max ${max_tickets}). Total tickets set to  ` + tickets);
                  } else {
                      tickets = read_tickets;
                  }
              } else if(initialize) { // run at site loading
                  tickets = read_tickets;
              }
              mapdata.tickets = tickets;
              $("#total-tickets").html(tickets);
          }
          function deduct_eticket() {
              store_scorecard(`tickets`, --mapdata.tickets);
              $("#total-tickets").text(mapdata.tickets);
          }
          function clear_mapdata() {
              if(!confirm("Are you sure you want to clear MapData from localStorage?")) return;
              mapdata.population = 0; mapdata.enrolled = 0; mapdata.tickets = 0;
              remove_item_scorecard('population/total');
              store_scorecard(`population/total`, 1001); // TBD
              remove_item_scorecard('enrolled/total');
              remove_item_scorecard('tickets');
              remove_item_scorecard('ticket-coll-time');
              load_mapdata();
              tickets_handling(1); // run in initialize mode
              console.log(mapdata)
          }
          function remove_item_scorecard(key='tickets') {
              let pathkey = `${info.project}`;
              let db = window.localStorage.getItem(user.id);
              // console.log(db);
              if(!db) db = {}; else db = JSON.parse(db);
              if(!db[pathkey]) db[pathkey] = {};
              if(!db[pathkey].scorecard) db[pathkey].scorecard = {};
              delete db[pathkey].scorecard[key];
              console.log(`db[pathkey].scorecard: (where pathkey = ${pathkey})`)
              console.log(db[pathkey].scorecard);
              window.localStorage.setItem(user.id, JSON.stringify(db));
          }

          function load_mapdata() {
              mapdata.population = retrieve_scorecard(`population/total`) || 0;
              mapdata.enrolled = retrieve_scorecard(`enrolled/total`) || 0;
              mapdata.tickets = retrieve_scorecard(`tickets`) || 0;
              $("#total-population").text(mapdata.population);
              $("#total-enrolled").text(mapdata.enrolled);
              $("#total-tickets").text(mapdata.tickets);
          }
          function store_mapdata() {
              store_scorecard(`population/total`, mapdata.population);
              store_scorecard(`enrolled/total`, mapdata.enrolled);
              store_scorecard(`tickets`, mapdata.tickets);
              $("#total-population").text(mapdata.population);
              $("#total-enrolled").text(mapdata.enrolled);
              $("#total-tickets").text(mapdata.tickets);
          }
          function update_mapdata({population=0, enrolled=0, tickets=0}={}) {
              mapdata.population += population;
              mapdata.enrolled += enrolled;
              mapdata.tickets += tickets;
              store_mapdata();
          }
          function update_mapdata_temp({population=0, enrolled=0, tickets=0}={}) {
              mapdata.population += population;
              mapdata.enrolled += enrolled;
              mapdata.tickets += tickets;
              $("#total-population").text(mapdata.population);
              $("#total-enrolled").text(mapdata.enrolled);
              $("#total-tickets").text(mapdata.tickets);
          }
          function store_mapdata_region(i, j, data={}) {
              store_scorecard(`population/space-${i}-${j}`, data.population||0);
              store_scorecard(`enrolled/space-${i}-${j}`, data.enrolled||0);
              // store_scorecard(`tiles/space-${i}-${j}`, data.revealed||0);
          }
          function retrieve_mapdata_region(i, j) {
              let population = retrieve_scorecard(`population/space-${i}-${j}`) || 0;
              let enrolled = retrieve_scorecard(`enrolled/space-${i}-${j}`) || 0;
              let revealed = retrieve_scorecard(`tiles/space-${i}-${j}`) || 0;
              return {population, enrolled, revealed};
          }
          function update_mapdata_region(i, j, data={}) {
              if(i===undefined || j===undefined) return;
              let stored = retrieve_mapdata_region(i, j);
              let population = stored.population + (data.population||0);
              let enrolled = stored.enrolled + (data.enrolled||0);
              // let revealed = s_revealed + (data.revealed||0);
              store_scorecard(`population/space-${i}-${j}`, population);
              store_scorecard(`enrolled/space-${i}-${j}`, enrolled);
              // store_scorecard(`tiles/space-${i}-${j}`, revealed?1:0);
          }
          function update_mapdata_region_temp(i, j, data={}) {
              let stored = retrieve_mapdata_region(i, j);
              let population = stored.population + (data.population||0);
              let enrolled = stored.enrolled + (data.enrolled||0);
              // let revealed = s_revealed + (data.revealed||0);
              console.log(`s_population/space-${i}-${j}`, stored.population);
              console.log(`s_enrolled/space-${i}-${j}`, stored.enrolled);
              // console.log(`s_tiles/space-${i}-${j}`, s_revealed?1:0);

              console.log(`population/space-${i}-${j}`, population);
              console.log(`enrolled/space-${i}-${j}`, enrolled);
              // console.log(`tiles/space-${i}-${j}`, revealed?1:0);
          }
          function get_difficulty_skill(i, j) {
              let {population, enrolled, revealed} = retrieve_mapdata_region(i, j);
              let skill = round(average_level()) || 1;
              let difficulty = round(enrolled/population*100) || 0;
              return {difficulty, skill};
          }
          function get_grid_cell_style(i, j, revealed) {
              let {population, enrolled, tickets} = mapdata;
              let {difficulty, skill} = get_difficulty_skill(i, j);
              let icon = (revealed) ? 'insert_comment' : 'short_text';
              let size = (revealed) ? '30px' : '72px';
              let color = (revealed) ? 'green' : 'lightgray';
              if(population < 200) { color = 'dimgray'; size = '30px'; }
              else if(tickets <= 0) { color = 'dimgray'; size = '30px'; }
              else if(tickets >= 1) {
                  if(skill > difficulty/2) { color = 'brown'; size = '30px'; }
                  if(skill > difficulty) { color = 'red'; size = '30px'; }
              }
              let opacity_fg = (revealed) ? 1 : 0;
              let opacity_bg = (revealed) ? 0 : 1;
              return {icon, color, size, opacity_fg, opacity_bg};
          }

          function add_grid_cell(i, j, ij, revealed) {
              if(i===undefined || j===undefined) return;
              let {icon, color, size, opacity_fg, opacity_bg} = get_grid_cell_style(i, j, revealed);
              return `
          <!-- <div class="card"> -->
            <!-- <img src="..." class="card-img-top" alt="..."> -->
            <div class="card-body m-0 p-0 mb-n2">
              <!-- <h5 class="card-title">Card title</h5> -->
              <!-- <p class="card-text"></p> -->
              <i class="material-icons btn-light" id="grid-cell-bg-${i}-${j}" style="font-size:172px;color:lightgray;opacity:${opacity_bg}" data-toggle1="clickover" data-prod="0" onclick="collect_map_space(${i}, ${j})">short_text</i>
              <i class="material-icons btn-light" id="grid-cell-ppl-${i}-${j}" style="font-size:${size};color:${color};opacity:${opacity_fg}; position:absolute; margin: 70px 0 0 -90px" data-toggle1="clickover" data-prod="0" onclick="launch_enrollment_quest(${i}, ${j}, this)">${icon}</i>
            </div>
          <!-- </div> -->`;
          }
          function update_grid_cell(i, j, revealed=true) {
              if(i===undefined || j===undefined) return;
              let {icon, color, size, opacity_fg, opacity_bg} = get_grid_cell_style(i, j, revealed);
              $(`#grid-cell-ppl-${i}-${j}`).html(icon);
              $(`#grid-cell-ppl-${i}-${j}`).css('color', color);
              $(`#grid-cell-ppl-${i}-${j}`).css('size', size);
              $(`#grid-cell-ppl-${i}-${j}`).css('opacity', opacity_fg);
              $(`#grid-cell-bg-${i}-${j}`).css('opacity', opacity_bg);
          }

          // function add_grid_cell(i, j, ij, revealed) {
          //     if(i===undefined || j===undefined) return;
          //     // let revealed = retrieve_scorecard(`tiles/space-${i}-${j}`);
          //     // let [population, tickets] = get_population_tickets();
          //     // let [difficulty, skill] = get_difficulty_skill();
          //     // let {population, enrolled, tickets} = retrieve_mapdata_top();
          //     let {population, enrolled, tickets} = mapdata;
          //     let {difficulty, skill} = get_difficulty_skill(i, j);
          //     let icon = (revealed) ? 'insert_comment' : 'short_text';
          //     let size = (revealed) ? '30px' : '72px';
          //     let color = (revealed) ? 'green' : 'lightgray';
          //     if(population < 1000) { color = 'dimgray'; size = '30px'; }
          //     else if(tickets <= 0) { color = 'dimgray'; size = '30px'; }
          //     else if(tickets >= 1) {
          //         if(skill > difficulty/2) { color = 'brown'; size = '30px'; }
          //         if(skill > difficulty) { color = 'red'; size = '30px'; }
          //     }
          //     let opacity_fg = (revealed) ? 1 : 0;
          //     let opacity_bg = (revealed) ? 0 : 1;
          //     return `
          // <!-- <div class="card"> -->
          //   <!-- <img src="..." class="card-img-top" alt="..."> -->
          //   <div class="card-body m-0 p-0 mb-n2">
          //     <!-- <h5 class="card-title">Card title</h5> -->
          //     <!-- <p class="card-text"></p> -->
          //     <i class="material-icons btn-light" id="grid-cell-bg-${i}-${j}" style="font-size:172px;color:lightgray;opacity:${opacity_bg}" data-toggle1="clickover" data-prod="0" onclick="collect_map_space(${i}, ${j})">short_text</i>
          //     <i class="material-icons btn-light" id="grid-cell-ppl-${i}-${j}" style="font-size:${size};color:${color};opacity:${opacity_fg}; position:absolute; margin: 70px 0 0 -90px" data-toggle1="clickover" data-prod="0" onclick="launch_enrollment_quest(${i}, ${j}, this)">${icon}</i>
          //   </div>
          // <!-- </div> -->`;
          // }

    //       function reveal_now(i, j) {
    //           console.log(`${i}, ${j}`);
    //           $(`#grid-cell-${i}-${j}`).popover(`hide`);
    //       }
    //       $(function () {
    //         let content = `<a class='btn-primary' role="button" data-toggle="clickover" style="white-space: pre"><span>Cost 50</span></a>`;
    //         // let header = `<a class='btn-light' role="button" data-toggle="clickover" style="white-space: pre"><span>Reveal</span></a>`;
    //         let header = `<a id="close-popover" data-toggle="clickover" class="btn btn-small btn-warning pull-left" onclick="$(this.parentNode.parentNode).popover(&quot;hide&quot;);">Reveal</a>`;
    // //         var elem = '<div class="well"><a href="google.com">Message one, From someone.</a></div>'+
    // // '<div class="well"><a type="button" class="btn-primary" href="google.com">Message one, From someone.</a></div>'+
    // // '<button id="close-popover" data-toggle="clickover" class="btn btn-small btn-primary pull-right" onclick="$(&quot;#meddelanden&quot;).popover(&quot;hide&quot;);">Close please!</button>';



    // //         $('.pop-space').popover({animation:true, content:elem, html:true});

    //         // $('.pop-space').popover({title: header, content: "Cost 50", html: true})
    //         for(let i=0; i<5; i++) {
    //             for(let j=0; j<5; j++) {
    //                 // let space = document.getElementById(`space-${i}-${j}`);
    //                 // if(!space) continue;
    //                 // let header = `<a id="close-popover-${i}-${j}" data-toggle="clickover" class="btn btn-small btn-warning pull-left" onclick="$(&quot;#grid-cell-${i}-${j}&quot;).popover(&quot;hide&quot;);">Reveal</a>`;
    //                 let header = `<a id="close-popover-${i}-${j}" data-toggle="clickover" class="btn btn-small btn-warning pull-left" onclick="reveal_now(${i}, ${j})">Reveal</a>`;
    //                 let content = `<a class='btn-primary' role="button" data-toggle="clickover" style="white-space: pre"><span>Cost 50</span></a>`;
    //                 $(`#grid-cell-${i}-${j}`).popover({title: header, content: "Cost 50", html: true})
    //             }
    //         }
    //       })
          function set_automagic() {
              automagic = parseInt($("#automagic").text()) || 0;
              console.log(`automagic set to ${automagic}`);
              voice_on = 0; // turn off voice mode
              nopopup = 1;
          }
          function set_speedup(_speedup=10) {
              speedup = _speedup; //parseInt($("#speedup").text()) || 1;
              console.log(`speedup set to ${speedup}x`);
              if(speedup>=60) accelerate = speedup>=3600 ? 100 : speedup>=360 ? 10 : 3;
              console.log(`speedup set to ${speedup}x, accelerate (${accelerate}x) `);
          }
          function set_accelerate(_accelerate=3) {
              accelerate = _accelerate; //parseInt($("#accelerate").text()) || 1;
              console.log(`accelerated (${accelerate}x) speedup set to ${speedup}x`);
          }
          // function set_speedup() {
          //     accelerate = 1;
          //     speedup = parseInt($("#speedup").text()) || 1;
          //     console.log(`speedup set to ${speedup}x`);
          // }
          // function set_accelerate() {
          //     // accelerate = 10
          //     speedup = parseInt($("#speedup").text()) || 1;
          //     accelerate = parseInt($("#accelerate").text()) || 1;
          //     console.log(`accelerated (${accelerate}x) speedup set to ${speedup}x`);
          // }
      </script>

      <div class="modal" tabindex="-1">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-body">
              <p>Cost 50</p>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
              <button type="button" class="btn btn-primary" onclick="reveal_now()">Reveal</button>
            </div>
          </div>
        </div>
      </div>

      <script type="text/javascript">

          // function begin_enrollment(i) {
          //   let population = get_population(i);
          //   let enrolled = get_enrolled(i);
          //   let avg_level = round(average_level()) || 1;
          //   launch_chatbot(i, aaa, avg_level);
          // }

          // function retrieve_mapdata_region(i, j) {
          //     let population = retrieve_scorecard(`population/space-${i}-${j}`) || 0;
          //     let enrolled = retrieve_scorecard(`enrolled/space-${i}-${j}`) || 0;
          //     let revealed = retrieve_scorecard(`tiles/space-${i}-${j}`) || 0;
          //     return {population, enrolled, revealed};
          // }

          async function launch_enrollment_quest(i, j, _this) {
              let index = i + j*5;
              let region = retrieve_mapdata_region(i, j);
              console.log(`region (${i}, ${j}) `, region);
              if(!region.revealed) { console.log(`Region (${i}, ${j}) not yet revealed. Can't enroll.`); return; }
              if(mapdata.population < 200) { return populate_tile(i, j) }
              if(mapdata.tickets < 1) if(confirm('You have used up all your tickets today. Come back tomorrow!\nPress "cancel" if you want to try anyway (using borrowed tickets)./')) return;
              let {difficulty, skill} = get_difficulty_skill(i, j);
              console.log(`initial region`, region)
              console.log(`initial map`, mapdata)

              console.log(`launch_chatbot(index=${index}, difficulty=${difficulty}, skill=${skill})`);
              let enrolled = await launch_chatbot(index, difficulty, skill);
              console.log(`done with launch_chatbot. enrolled ${enrolled}`);
              if(enrolled) {
                  region.enrolled += enrolled;
                  mapdata.enrolled += enrolled;
                  mapdata.tickets -= enrolled;
                  // update_mapdata_temp();
                  // update_mapdata_region_temp(i, j, {enrolled});
                  update_mapdata();
                  update_mapdata_region(i, j, {enrolled});
                  update_grid_cell(i, j);
              }
              console.log(`final region`, region)
              console.log(`final map`, mapdata)
          }

          // async function launch_enrollment_quest_old(i, j, _this) {
          //     let index = i + j*5;
          //     let map = { population: 1000, enrolled: 0, tickets: 1, coll_time: 0, regions: [] };
          //     let region = map.regions[index];
          //     if(!region) {
          //       region = { population: 100, enrolled: 20 };
          //       map.regions[0] = region;
          //     }

          //     // let index = parseInt($(_this).prep('data-index')) || 0;
          //     let avg_level = round(average_level()) || 1;
          //     let expertize = avg_level;
          //     let difficulty = round(region.enrolled/region.population*100) || 0;
          //     if(map.population < 1000) { return populate_tile(i, j) }
          //     if(map.tickets < 1) if(confirm('You have used up all your tickets today. Come back tomorrow!\nPress "cancel" if you want to try anyway (using borrowed tickets)./')) return;

          //     console.log(`launch_chatbot(index=${index}, difficulty=${difficulty}, expertize=${expertize})`);
          //     let enrolled = await launch_chatbot(index, difficulty, expertize);
          //     if(enrolled) {
          //         region.enrolled += enrolled;
          //         map.enrolled += enrolled;
          //         map.tickets -= enrolled;
          //         update_mapdata_top_temp({population: map.population, enrolled: map.enrolled, tickets: map.tickets});
          //     }
          //     console.log(`final region`, region)
          //     console.log(`final map`, map)
          // }

          // async function launch_chatbot(count, expertize, _this) {
          //     let enrolled = await launch_chatbot(i, count, expertize);
          //     total = (parseInt($(_this).prop('data-enrolled')) || 0) + enrolled;
          //     $(_this).prop('data-enrolled', total);
          //     // console.log(_this);
          //     // console.log($(_this).prop('data-enrolled'));
          //     $(_this).find('a').text(total);
          //     $(_this).find('a').css('color', 'dimgray');
          //     tickets = 3 - total;
          //     let color = tickets<=0 ? 'lightgray' : tickets<=1 ? '#6699cc' : tickets<=2 ? 'yellowgreen' : tickets<=2 ? 'yellow' : 'orange';
          //     $(_this).find('i').css('color', color);
          // }
      </script>

        <!-- Activate modal as: $('#chatbotModal').modal() -->
        <!-- Modal -->
        <div class="modal xmodal-wide fade" id="chatbotModal" tabindex="-1" role="dialog" aria-labelledby="chatbotModalTitle" aria-hidden="true" style1="width:90%">
          <div class="modal-dialog modal-dialog-centered modal-lg xmodal-wide" role="document" style1="width:90%">
            <div class="modal-content modal-widepx" style1="xwidth:800px">
              <div class="modal-header theme_light">
                <div class="row col-12 xrow-cols-sm-1">
                    <h1 class="modal-title lead col-4" id="enrollModalTitle" xstyle="display:inline;float:left">Conversing ...</h1>
                    <!-- <button type="button" class="close" data-dismiss="modal" aria-label="Close"> -->
                      <!-- <span aria-hidden="true">&times;</span> -->
                    <!-- </button> -->
                    <h2 class="modal-title lead col-4 text-center" xstyle="display:inline;margin-left:25%;color:dimgray">Points <span id="joinModalPoints">0</span></h2>
                    <h2 class="modal-title lead col-3 text-right" xstyle="display:inline;float:left;margin: 0px 12px 0 0;color:dimgray">Joined <span id="joinModalJoined">0</span></h2>
                    <button type="button" class="close xco text-right" data-dismiss="modal" style="color:black">&times;</button>
                </div>
              </div>
              <div class="modal-body modal-widepx bg_light" style1="xwidth:800px">
                <!-- <div class="card-group cols-12" id="chatbot-cards"> -->
                <div class="col-sm-12 col-sm-offset-0 chatbot-frame bg_light">
                    <ul id="chatbot-ul"></ul>
                    <div>
                        <div class="chatbot-msj-rta chatbot-macro">                        
                            <div class="chatbot-text chatbot-text-r" style="background:whitesmoke !important">
                                <input class="chatbot-mytext" placeholder="Type a message"/>
                            </div> 
                        </div>
                        <div style="padding:10px;">
                            <!-- <span class="glyphicon glyphicon-share-alt"></span> -->
                            <!-- <i class="material-icons" style="color:dimgray; font-size:24px;">send</i> -->
                        </div>                
                            <p>
                              <button class="btn btn-light px-2" type="button" data-toggle="collapse" data-target="#chatbotSettings" aria-expanded="false" aria-controls="chatbotSettings">
                                  <i class="material-icons" style="color:lightgray; font-size:20px;">settings</i>
                              </button>
                            </p>
                            <div class="collapse" id="chatbotSettings">
                              <div class="card card-body">

                                    <form>
                                      <div class="form-row align-items-center">
                                        <div class="col-auto my-1">
                                          <label class="mr-sm-2 sr-only" for="inlineFormCustomSelect">Preference</label>
                                          <select class="custom-select mr-sm-2" id="inlineFormPromptsSelect" onchange="chatbotPromptsSettingsChange(this)">
                                            <!-- <option selected>Prompts...</option> -->
                                            <option value="1">Complete sentences</option>
                                            <option value="2" selected>Phrases (multi word)</option>
                                            <option value="3">Words (single word)</option>
                                          </select>
                                        </div>
                                        <div class="col-auto my-1">
                                          <label class="mr-sm-2 sr-only" for="inlineFormCustomSelect">Preference</label>
                                          <select class="custom-select mr-sm-2" id="inlineFormHintsSelect" onchange="chatbotHintsSettingsChange(this)">
                                            <!-- <option selected>Hints...</option> -->
                                            <option value="1">English lines only (100% points)</option>
                                            <option value="2" selected>Hints in English (50% points)</option>
                                            <option value="3">Hints in Punjabi (25% points)</option>
                                          </select>
                                        </div>
                                        <div>
                                            <label for="customRange3">Font Size</label>
                                            <input type="range" class="custom-range" min="10" max="30" step="1" value="16" id="chatbotFontSize" onchange="chatbotFontSizeChange(this)">     
                                        </div>                                   
                                        <br>
                                        <div class="col-auto my-1">
                                          <div class="custom-control custom-checkbox mr-sm-2">
                                            <input type="checkbox" class="custom-control-input" id="chatbotFeedbackSetting" onclick="chatbotModeSettingsChange(this, 'feedback')" checked>
                                            <label class="custom-control-label" for="chatbotFeedbackSetting">Show feedback</label>
                                          </div><hr>
                                          <div class="custom-control custom-checkbox mr-sm-2">
                                            <input type="checkbox" class="custom-control-input" id="chatbotExpertSetting" onclick="chatbotModeSettingsChange(this, 'expert')">
                                            <label class="custom-control-label" for="chatbotExpertSetting">Expert mode</label><br>
                                          </div>
                                          <div class="custom-control custom-checkbox mr-sm-2">
                                            <input type="checkbox" class="custom-control-input" id="chatbotDuplexSetting" onclick="chatbotModeSettingsChange(this, 'duplex')" checked>
                                            <label class="custom-control-label" for="chatbotDuplexSetting">Duplex mode</label><br>
                                          </div>
                                          <div class="custom-control custom-checkbox mr-sm-2">
                                            <input type="checkbox" class="custom-control-input" id="chatbotQuietSetting" onclick="chatbotModeSettingsChange(this, 'quiet')" checked>
                                            <label class="custom-control-label" for="chatbotQuietSetting">Quiet mode</label><br>
                                          </div>
                                          <div class="custom-control custom-checkbox mr-sm-2" hidden>
                                            <input type="checkbox" class="custom-control-input" id="chatbotTestSetting" onclick="chatbotModeSettingsChange(this, 'test')">
                                            <label class="custom-control-label" for="chatbotTestSetting">Test mode</label>
                                          </div>
                                        </div>
                                      </div>
                                    </form>

                              </div>
                            </div>

                    </div>
                </div>

                <!-- </div> -->
              </div>
              <!-- <div class="modal-footer theme_primary"> -->
                <!-- <div class="row col-12"> -->
                    <!-- <button class="btn btn-light col-3" disabled></button> -->
                    <!-- <button type="button" class="btn btn-info col-6" id="offering" style="float:center" onclick="on_click_accept()">Accept my offerings</button> -->
                    <!-- <button type="button" class="btn btn-info col-6" data-dismiss="modal" id="offering" style="float:center">Accept my offerings</button> -->
                    <!-- <button class="btn btn-light col-3" disabled></button> -->
                <!-- </div> -->
              <!-- </div> -->
            </div>
          </div>
        </div>

        <div class="modal fade" id="utilModal" tabindex="-1">
          <div class="modal-dialog modal-sm xmodal-dialog-centered" id="utilModalDialog" style="max-width:400px">
            <div class="modal-content">
            <!-- <div class="modal-header">
                <h5 class="modal-title" id="utilModalTitle"></h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                </button>
              </div> -->
              <div class="modal-body" id="utilModalBody">
                    <h5 class="modal-title" id="utilModalTitle"></h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                      <span aria-hidden="true">&times;</span>
                    </button>
                    <p id="utilModalBodyText">Placeholder</p>
              </div>
            </div>
          </div>
        </div>

      <footer class="pt-4 my-md-5 pt-md-5 border-top">
          <div class="row">
            <div class="col-6 col-md">
              <h6>Reporting</h6>
              <ul class="list-unstyled text-small">
                <li><a class="text-muted text-exempt" href="#" onclick="check_progress()">Check Progress</a></li>
                <div hidden>
                  <li><a class="text-muted text-exempt" href="#" onclick="launch_chatbot(1, 3, this)">Launch Chatbot</a></li>
                </div>
                <!-- <li><a class="text-muted" href="#">Random feature</a></li> -->
                <!-- <li><a class="text-muted" href="#">Team feature</a></li> -->
              </ul>
            </div>
            <div class="col-6 col-md">
              <h6>Resources</h6>
              <ul class="list-unstyled text-small">
                <li><a class="text-muted text-exempt" href="#" onclick="clear_local_storage()">Clear local storage</a></li>
                <div hidden>
                  <li><a class="text-muted text-exempt" href="#" onclick="clear_mapdata()">Clear mapdata</a></li>
                  <li><a class="text-muted text-exempt" href="#" onclick="set_automagic()" hidden1>Auto test mode <span id="automagic">1<span></a></li>
                  <li><a class="text-muted text-exempt" href="#" onclick="set_speedup(10)" hidden1>Speedup <span id="speedup">10<span>x</a></li>
                  <li><a class="text-muted text-exempt" href="#" onclick="set_speedup(24)" hidden1>Speedup <span id="speedup">24<span>x</a></li>
                  <li><a class="text-muted text-exempt" href="#" onclick="set_speedup(60)" hidden1>Speedup <span id="speedup">60<span>x</a></li>
                  <li><a class="text-muted text-exempt" href="#" onclick="set_speedup(120)" hidden1>Speedup <span id="speedup">120<span>x</a></li>
                  <li><a class="text-muted text-exempt" href="#" onclick="set_speedup(180)" hidden1>Speedup <span id="speedup">180<span>x</a></li>
                  <li><a class="text-muted text-exempt" href="#" onclick="set_speedup(360)" hidden1>Speedup <span id="speedup">360<span>x</a></li>
                  <li><a class="text-muted text-exempt" href="#" onclick="set_speedup(3600)" hidden1>Speedup <span id="speedup">3600<span>x</a></li>
                  <li><a class="text-muted text-exempt" href="#" onclick="set_speedup(24*3600)" hidden1>Speedup <span id="speedup">24*3600<span>x</a></li>
                  <li><a class="text-muted text-exempt" href="#" onclick="set_accelerate(1)" hidden1>Accelerate <span id="accelerate">1<span>x</a></li>
                  <li><a class="text-muted text-exempt" href="#" onclick="set_accelerate(3)" hidden1>Accelerate <span id="accelerate">3<span>x</a></li>
                  <li><a class="text-muted text-exempt" href="#" onclick="set_accelerate(10)" hidden1>Accelerate <span id="accelerate">10<span>x</a></li>
                  <li><a class="text-muted text-exempt" href="#" onclick="set_accelerate(100)" hidden1>Accelerate <span id="accelerate">100<span>x</a></li>
                </div>
                <!-- <li><a class="text-muted" href="#">Resource name</a></li> -->
                <!-- <li><a class="text-muted" href="#">Another resource</a></li> -->
              </ul>
            </div>
            <div class="col-6 col-md">
              <h6>About</h6>
              <ul class="list-unstyled text-small">
                <li><a class="text-muted" href="#">Version <span id="version">0.0</span></a></li>
                <!-- <li><a class="text-muted" href="#">Locations</a></li> -->
              </ul>
            </div>
          </div>
        </footer>

  </body>
</html>
